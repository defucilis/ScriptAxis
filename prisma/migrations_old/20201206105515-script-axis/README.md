# Migration `20201206105515-script-axis`

This migration has been generated by Lachlan Sleight <defucilis@gmail.com> at 12/6/2020, 9:55:15 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "Script" (
"id" SERIAL,
    "name" TEXT NOT NULL,
    "slug" TEXT NOT NULL,
    "description" TEXT,
    "duration" INTEGER NOT NULL,
    "thumbnail" TEXT NOT NULL,
    "sourceUrl" TEXT,
    "active" BOOLEAN NOT NULL DEFAULT true,
    "likeCount" INTEGER NOT NULL DEFAULT 0,
    "thumbsUp" INTEGER NOT NULL DEFAULT 1,
    "thumbsDown" INTEGER NOT NULL DEFAULT 0,
    "views" INTEGER NOT NULL DEFAULT 0,
    "created" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "modified" TIMESTAMP(3) NOT NULL,
    "creatorName" TEXT NOT NULL,
    "userId" TEXT NOT NULL,
    "categoryName" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "Creator" (
    "name" TEXT NOT NULL,
    "totalViews" INTEGER NOT NULL DEFAULT 0,
    "totalLikes" INTEGER NOT NULL DEFAULT 0,
    "created" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "modified" TIMESTAMP(3) NOT NULL,
    "userId" TEXT,

    PRIMARY KEY ("name")
)

CREATE TABLE "Category" (
    "name" TEXT NOT NULL,
    "count" INTEGER NOT NULL DEFAULT 0,

    PRIMARY KEY ("name")
)

CREATE TABLE "Tag" (
    "name" TEXT NOT NULL,
    "count" INTEGER NOT NULL DEFAULT 0,
    "scriptId" INTEGER,

    PRIMARY KEY ("name")
)

CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "username" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "created" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "modified" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "VerificationRequest" (
    "id" INTEGER NOT NULL,
    "status" INTEGER NOT NULL DEFAULT 0,
    "created" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "modified" TIMESTAMP(3) NOT NULL,
    "userId" TEXT NOT NULL,
    "scriptId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "_ScriptLiker" (
    "A" INTEGER NOT NULL,
    "B" TEXT NOT NULL
)

CREATE UNIQUE INDEX "Script.slug_unique" ON "Script"("slug")

CREATE UNIQUE INDEX "Creator_userId_unique" ON "Creator"("userId")

CREATE UNIQUE INDEX "User.username_unique" ON "User"("username")

CREATE UNIQUE INDEX "User.email_unique" ON "User"("email")

CREATE UNIQUE INDEX "_ScriptLiker_AB_unique" ON "_ScriptLiker"("A", "B")

CREATE INDEX "_ScriptLiker_B_index" ON "_ScriptLiker"("B")

ALTER TABLE "Script" ADD FOREIGN KEY("creatorName")REFERENCES "Creator"("name") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Script" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Script" ADD FOREIGN KEY("categoryName")REFERENCES "Category"("name") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Creator" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "Tag" ADD FOREIGN KEY("scriptId")REFERENCES "Script"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "VerificationRequest" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "VerificationRequest" ADD FOREIGN KEY("scriptId")REFERENCES "Script"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_ScriptLiker" ADD FOREIGN KEY("A")REFERENCES "Script"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_ScriptLiker" ADD FOREIGN KEY("B")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201206105515-script-axis
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,80 @@
+// This is your Prisma schema file,
+// learn more about it in the docs: https://pris.ly/d/prisma-schema
+
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+generator client {
+  provider = "prisma-client-js"
+}
+
+// Everything required to store a funscript - this will change in the future!
+model Script {
+  id                Int         @default(autoincrement()) @id
+  name              String
+  slug              String      @unique
+  creator           Creator
+  owner             User        @relation("ScriptOwner")
+  category          Category
+  tags              Tag[]
+  description       String?
+  duration          Int
+  thumbnail         String
+  sourceUrl         String?
+  active            Boolean     @default(true)
+  likedBy           User[]      @relation("ScriptLiker")
+  likeCount         Int         @default(0)
+  thumbsUp          Int         @default(1)
+  thumbsDown        Int         @default(0)
+  views             Int         @default(0)
+  created           DateTime    @default(now())
+  modified          DateTime    @updatedAt
+}
+
+// Creators of scripts - may or may not be connected to a user account
+model Creator {
+  name              String      @id
+  user              User?
+  scripts           Script[]
+  totalViews        Int         @default(0)
+  totalLikes        Int         @default(0)
+  created           DateTime    @default(now())
+  modified          DateTime    @updatedAt
+}
+
+// Top-level categories for scripts - each script has only one
+model Category {
+  name              String      @id
+  scripts           Script[]
+  count             Int         @default(0)
+}
+
+// Tags for scripts - each script can have more than one
+model Tag {
+  name              String      @id
+  count             Int         @default(0)
+}
+
+// User accounts - not in use yet
+model User {
+  id                String      @default(uuid()) @id
+  username          String      @unique
+  email             String      @unique
+  creator           Creator?
+  ownedScripts      Script[]    @relation("ScriptOwner")
+  likedScripts      Script[]    @relation("ScriptLiker")
+  created           DateTime    @default(now())
+  modified          DateTime    @updatedAt
+}
+
+// The verification queue for moderators to consider - not in use yet
+model VerificationRequest {
+  id                Int         @id
+  user              User
+  status            Int         @default(0)
+  script            Script
+  created           DateTime    @default(now())
+  modified          DateTime    @updatedAt
+}
```
